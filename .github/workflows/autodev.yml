# AutoDev Workflow
# This workflow executes tasks using Claude Code CLI

name: 'AutoDev'
run-name: 'AutoDev: ${{ inputs.task_title }}'

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: "Task ID"
        type: string
        required: true
      composite_task_id:
        description: "Parent composite task ID (or 'standalone')"
        type: string
        required: true
      task_title:
        description: "Task title"
        type: string
        required: true
      prompt:
        description: "Task prompt/description"
        type: string
        required: true
      base_branch:
        description: "Branch to work on"
        type: string
        required: true
      target_branch:
        description: "Target branch for PR"
        type: string
        required: true
      autodev_server_url:
        description: "AutoDev server URL for callbacks"
        type: string
        required: false
        default: "http://localhost:3000"

jobs:
  execute_task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config user.name "AutoDev Bot"
          git config user.email "autodev@github-actions.bot"

      - name: Execute task with Claude Code
        id: claude_execution
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "============================================================"
          echo "AutoDev Task Executor (Claude Code CLI)"
          echo "Task ID: ${{ inputs.task_id }}"
          echo "Task: ${{ inputs.task_title }}"
          echo "============================================================"
          echo ""

          # Execute Claude Code with automatic permissions (based on official docs)
          # https://docs.claude.com/en/docs/claude-code/headless
          # https://docs.claude.com/en/docs/claude-code/cli-reference
          claude \
            --print \
            --dangerously-skip-permissions \
            --permission-mode acceptEdits \
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep" \
            --model sonnet \
            --max-turns 10 \
            --output-format stream-json \
            "${{ inputs.prompt }}"

          echo ""
          echo "✓ Claude Code execution completed"

      - name: Commit and push changes
        id: commit
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "AutoDev: ${{ inputs.task_title }}

          Task ID: ${{ inputs.task_id }}
          Composite Task: ${{ inputs.composite_task_id }}

          ${{ inputs.prompt }}

          Generated with AutoDev
          Co-Authored-By: Claude <noreply@anthropic.com>"
            git push origin ${{ inputs.base_branch }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/pr_body.md << 'EOFPR'
          ## Task: ${{ inputs.task_title }}

          **Task ID:** `${{ inputs.task_id }}`
          **Composite Task:** `${{ inputs.composite_task_id }}`

          ### Description
          ${{ inputs.prompt }}

          ### Changes
          This PR contains the automated changes for this task.

          ---
          🤖 Generated with [AutoDev](https://github.com/load28/a-dev)
          Powered by Claude 4.5 Sonnet
          EOFPR

          PR_URL=$(gh pr create \
            --base "${{ inputs.target_branch }}" \
            --head "${{ inputs.base_branch }}" \
            --title "AutoDev: ${{ inputs.task_title }}" \
            --body-file /tmp/pr_body.md)

          echo "PR created: $PR_URL"

          # URL에서 PR 번호 추출 (예: https://github.com/owner/repo/pull/123 -> 123)
          PR_NUMBER=$(echo "$PR_URL" | sed 's/.*\/pull\///')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Notify AutoDev Server
        if: always()
        run: |
          SUCCESS="true"
          ERROR_MSG=""

          if [ "${{ job.status }}" != "success" ]; then
            SUCCESS="false"
            ERROR_MSG="Workflow failed with status: ${{ job.status }}"
          fi

          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"
          PR_URL="${{ steps.create_pr.outputs.pr_url }}"

          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER="null"
          fi

          if [ -z "$PR_URL" ]; then
            PR_URL="null"
          else
            PR_URL="\"$PR_URL\""
          fi

          PAYLOAD=$(cat <<EOF
          {
            "task_id": "${{ inputs.task_id }}",
            "composite_task_id": "${{ inputs.composite_task_id }}",
            "repository_owner": "${{ github.repository_owner }}",
            "repository_name": "${{ github.event.repository.name }}",
            "pr_number": $PR_NUMBER,
            "pr_url": $PR_URL,
            "success": $SUCCESS,
            "error": $([ -z "$ERROR_MSG" ] && echo "null" || echo "\"$ERROR_MSG\"")
          }
          EOF
          )

          echo "Notifying AutoDev server..."
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "${{ inputs.autodev_server_url }}/callbacks/workflow-complete" \
            || echo "Failed to notify server (non-fatal)"
