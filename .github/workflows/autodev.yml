# AutoDev GitHub Actions Workflow
# ì´ workflowëŠ” AutoDev ì—”ì§„ì´ íŠ¸ë¦¬ê±°í•˜ì—¬ AI ì—ì´ì „íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  PRì„ ìƒì„±í•©ë‹ˆë‹¤

name: AutoDev - AI Development Automation

on:
  # AutoDev ì—”ì§„ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Task ID'
        required: true
        type: string
      branch:
        description: 'Branch name for the changes'
        required: true
        type: string
      commit_message:
        description: 'Commit message'
        required: true
        type: string
      prompt:
        description: 'AI agent prompt'
        required: false
        type: string

  # PR ì´ë²¤íŠ¸ (ë¦¬ë·° ì²˜ë¦¬, CI ì‹¤íŒ¨ ì²˜ë¦¬)
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  # AI ì—ì´ì „íŠ¸ ì‹¤í–‰ ë° PR ìƒì„±
  execute_task:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Claude Code CLI
        run: |
          # Claude Code CLI ì„¤ì¹˜ (ì‹¤ì œ ì„¤ì¹˜ ë°©ë²•ì— ë”°ë¼ ìˆ˜ì •)
          echo "Installing Claude Code CLI..."
          # curl -fsSL https://claude.ai/install.sh | sh

      - name: Execute AI Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TASK_ID: ${{ inputs.task_id }}
          BRANCH_NAME: ${{ inputs.branch }}
        run: |
          echo "Executing AI agent for task: $TASK_ID"

          # ë¸Œëžœì¹˜ ìƒì„±
          git checkout -b "$BRANCH_NAME"

          # Claude Code ì‹¤í–‰
          # claude-code "${{ inputs.prompt }}" --auto-commit

          # ì‹œë®¬ë ˆì´ì…˜: ìž„ì‹œ íŒŒì¼ ìƒì„±
          mkdir -p src
          echo "// Task: ${{ inputs.task_id }}" > src/task_$TASK_ID.rs
          echo "// Generated by AutoDev" >> src/task_$TASK_ID.rs

      - name: Commit changes
        run: |
          git config user.name "AutoDev Bot"
          git config user.email "autodev@github.com"
          git add .
          git commit -m "${{ inputs.commit_message }}" || echo "No changes to commit"

      - name: Push changes
        run: |
          git push origin "${{ inputs.branch }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ inputs.branch }}
          title: "${{ inputs.commit_message }}"
          body: |
            ## AutoDev Task

            **Task ID:** `${{ inputs.task_id }}`
            **Branch:** `${{ inputs.branch }}`

            This PR was automatically generated by AutoDev.

            ### Changes
            - Automated code generation by AI agent

            ---
            *Generated by AutoDev - AI Development Automation*
          labels: autodev, automated

  # PR ë¦¬ë·° ìžë™ ì²˜ë¦¬
  handle_review:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Check if AutoDev PR
        id: check_autodev
        run: |
          if [[ "${{ github.event.pull_request.title }}" == *"AutoDev"* ]] || \
             [[ "${{ github.event.pull_request.labels }}" == *"autodev"* ]]; then
            echo "is_autodev=true" >> $GITHUB_OUTPUT
          else
            echo "is_autodev=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        if: steps.check_autodev.outputs.is_autodev == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Claude Code CLI
        if: steps.check_autodev.outputs.is_autodev == 'true'
        run: |
          echo "Installing Claude Code CLI..."

      - name: Apply review feedback
        if: steps.check_autodev.outputs.is_autodev == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          echo "Applying review feedback..."

          # Claude Codeë¡œ ë¦¬ë·° ì½”ë©˜íŠ¸ì— ëŒ€ì‘
          # claude-code "Apply these review comments: $REVIEW_BODY" --auto-commit

          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git config user.name "AutoDev Bot"
          git config user.email "autodev@github.com"
          git add .
          git commit -m "fix: apply review feedback" || echo "No changes needed"
          git push

      - name: Comment on PR
        if: steps.check_autodev.outputs.is_autodev == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Applied fixes based on review comments automatically.'
            })

  # CI ì‹¤íŒ¨ ìžë™ ìˆ˜ì •
  handle_ci_failure:
    if: github.event_name == 'pull_request' && failure()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Check if AutoDev PR
        id: check_autodev
        run: |
          if [[ "${{ github.event.pull_request.labels }}" == *"autodev"* ]]; then
            echo "is_autodev=true" >> $GITHUB_OUTPUT
          else
            echo "is_autodev=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        if: steps.check_autodev.outputs.is_autodev == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Claude Code CLI
        if: steps.check_autodev.outputs.is_autodev == 'true'
        run: |
          echo "Installing Claude Code CLI..."

      - name: Fix CI failures
        if: steps.check_autodev.outputs.is_autodev == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "Analyzing CI failures..."

          # CI ë¡œê·¸ ìˆ˜ì§‘
          # CI_LOGS=$(gh run view ${{ github.run_id }} --log)

          # Claude Codeë¡œ CI ì‹¤íŒ¨ ìˆ˜ì •
          # claude-code "Fix these CI failures: $CI_LOGS" --auto-commit

          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git config user.name "AutoDev Bot"
          git config user.email "autodev@github.com"
          git add .
          git commit -m "fix: resolve CI failures" || echo "No fixes needed"
          git push

      - name: Comment on PR
        if: steps.check_autodev.outputs.is_autodev == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ”§ Fixed CI failures automatically.'
            })